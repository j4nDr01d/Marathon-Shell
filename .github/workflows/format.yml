name: Code Format Check

on:
  pull_request:
  push:
    branches: [ "main" ]

jobs:
  format-check:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Install formatting tools
        run: |
          sudo apt-get update
          sudo apt-get install -y qt6-declarative-dev-tools clang-format

      - name: Run formatters
        id: format
        continue-on-error: true
        run: |
          echo "=== Running clang-format ==="
          # Find C++ files excluding third-party and build directories
          find . -type f \( -name "*.cpp" -o -name "*.h" \) -not -path "./third-party/*" -not -path "./build*" -not -path "./.git/*" | xargs clang-format -i

          echo "=== Running qmlformat ==="
          # Find QML files excluding third-party and build directories
          # Try to find qmlformat, fallback to common paths
          if command -v qmlformat &> /dev/null; then
              QMLF="qmlformat"
          elif [ -f "/usr/lib/qt6/bin/qmlformat" ]; then
              QMLF="/usr/lib/qt6/bin/qmlformat"
          else
              echo "qmlformat not found!"
              exit 1
          fi
          
          find . -type f -name "*.qml" -not -path "./third-party/*" -not -path "./build*" -not -path "./.git/*" | xargs $QMLF -i

          if [[ -n $(git status --porcelain) ]]; then
            echo "needs_formatting=true" >> $GITHUB_OUTPUT
          else
            echo "needs_formatting=false" >> $GITHUB_OUTPUT
          fi

      - name: Post comment on PR if needed
        if: github.event_name == 'pull_request' && steps.format.outputs.needs_formatting == 'true'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            **Formatting changes required**
            This PR does not follow the formatting rules.
            Please run:
            ```bash
            clang-format -i <files>
            qmlformat -i <files> (must be from Qt 6)
            ```
            Commit the updated files and push again.

      - name: Fail job
        if: steps.format.outputs.needs_formatting == 'true'
        run: |
          echo "Formatting required. Failing."
          exit 1
